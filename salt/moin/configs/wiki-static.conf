server {
    listen 9000 ssl;
    server_name wiki.python.org wiki.jython.org moin.psf.io;

    ssl_certificate /etc/ssl/private/moin.psf.io.pem;
    ssl_certificate_key /etc/ssl/private/moin.psf.io.pem;

    include fastly_params;

    error_log /var/log/nginx/wiki-static.error.log;
    access_log /var/log/nginx/wiki-static.access.log main;

    root /data/www/wiki-static;

    # If the URI matches a MoinMoin-encoded filename, serve it directly
    if ($moin_rewrite) {
        rewrite ^ $moin_rewrite last;
    }

    location /psf/ {
        # Only require auth for restricted pages (90 pages with non-public ACLs)
        # $psf_restricted is set to 1 for restricted pages, 0 for public
        if ($psf_restricted) {
            rewrite ^ /psf-restricted$uri last;
        }
        try_files $uri $uri.html $uri/ =404;
    }

    # Internal location that serves restricted PSF pages with auth
    location /psf-restricted/psf/ {
        internal;
        auth_basic "PSF Wiki (restricted)";
        auth_basic_user_file /etc/nginx/.htpasswd-psf;
        alias /data/www/wiki-static/psf/;
        try_files $uri $uri.html $uri/ =404;
    }

    location /moin/ {
        alias /data/www/wiki-static/python/;
        try_files $uri $uri.html $uri/ =404;
    }

    location / {
        index index.html;
        try_files $uri $uri.html $uri/ =404;
    }
}
